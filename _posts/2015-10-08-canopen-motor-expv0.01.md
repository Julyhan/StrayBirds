---
layout: post
title: CANOpen 电机控制实验v0.01
category: 搬砖
comments: true
---

#CANOpen 电机控制实验v0.01

2015-10-05


###1.	实验开始之前

* 首先应将伺服工作模式设置为CANOpen模式

* 设置好伺服站号，即节点号NODE-ID

* 设置CANOpen波特率

* 阅读制造商手册，确定6040h对象字典高5位数值


###2.	报文格式

####数据格式：

Byte0 |	Byte1	Byte2 |	Byte3 |	Byte4	Byte5	Byte6	Byte7

CMD	INDEX	SUB	DATA

####其中：

* 主站向从站发送数据CMD（16进制）：

23：写32位数据

2B：写16位数据

2F：写8位数据

CMD|INDEX|SUBINDEX|DATA

*从站响应CMD：

60：数据接受成功

80：数据接收失败

CMD|INDEX|SUBINDEX|RESERVED

* 主站向从站接收数据CMD（16进制）：

40

CMD|INDEX|SUBINDEX|RESERVED

* 从站响应CMD：

43：32位数据

4B：16位数据

4F：8位数据

CMD|INDEX|SUBINDEX|DATA


### 3.	正式报文
#### 3.1 通讯建立

* //通讯对象启动信息报文

700+Node-ID 00

* //NMT对象进入运行状态ENTER OPERATIONAL

000 01 Node-ID

#### 3.2伺服参数

注意，该状态下：

主站命令之前应添加 600+节点号

从站相应会相应加上 580+节点号

* //设置电机模式

写 6060h 0 2//data:I8，将电机模式设置为2，速度模式

```600+节点号 2f 60 60 00 02 00 00 00```

* //读取电机模式

读 6061h 0 //data:I8，读取电机模式是否为2，速度模式

```600+节点号 40 61 60 00 00 00 00 00```

* //设置目标速度

写 6042h 0 0028h//data:I16,单位：rpm，将速度设成40rpm

```600+节点号 2b 42 60 00 28 00 00 00```

* //设置最大最小速度

写 6044h 1 00000000h//data:U32, 单位：rpm，将最小速度设成0rpm

写 6044h 2 00000100h//data:U32, 单位：rpm，将最大速度设成256rpm

```
600+节点号 23 44 60 01 00 00 00 00 
600+节点号 23 44 60 02 00 01 00 00
```

* //设置加速时的加速度

写 6048h 1 00000020h//data:U32, 单位：rpm/min， delta speed

```600+节点号 23 48 60 01 20 00 00 00```

写 6048h 2 003Ch//data:U16, 单位：s delta time

//将加速度设置成0020h/（3Ch/3C) = 32rpm/min^2

```600+节点号 2b 48 60 02 3C 00 00 00```

* //设置减速时的加速度

写 6049h 1 00000020h//data:U32, 单位：rpm/min， delta speed

写 6049h 2 003Ch//data:U16, 单位：s delta time

//将加速度设置成0020h/（3Ch/3C) = 32rpm/min^2

```
600+节点号 23 49 60 01 20 00 00 00
600+节点号 2b 49 60 02 3c 00 00 00
```

###3.3 运行状态

*6040高位需要查制造商的手册，11至15位为制造商指定*

* //驱动器准备上电

写 6040h 0 0076h//data: U32

```600+节点号 2b 40 60 00 76 00 00 00```

* //驱动器上电

写 6040h 0 0077h//

```600+节点号 2b 40 60 00 77 00 00 00```

* //操作使能

写 6040h 0 007Fh//

```600+节点号 2b 40 60 00 7f 00 00 00```

* //读取速度

读 6043h 0 //data:I16

```600+节点号 40 43 60 00 00 00 00 00```

* //读取e motor spindle or load速度

读 6044h 0 //data:I16

```600+节点号 44 60 00 00 00 00 00 00```


### 3.4 停止

* //将速度降低为0

//写 6042h 0 0000h//data:I16,单位：rpm，将速度设成0rpm

```600+节点号 2b 42 60 00 00 00 00 00```

* //Quick Stop

写 6040h 0 0072h

```600+节点号 2b 40 60 00 72 00 00 00```

* //关闭电机

写 6040h 0 0000h

```600+节点号 2b 40 60 00 00 00 00 00 ```

* //NMT对象进入停止状态

000 81 Node-ID

### 4.	控制字查询表
 
 
### 5.	参考资料
[《CANopen运动控制协议驱动程序设计》](http://d.wanfangdata.com.cn/Periodical/zhjc200704014)
[CiA Draft Standard Proposal 402]
